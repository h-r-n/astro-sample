---
title: "ã€Railsã€‘ActiveSupport::Concernã¨ã¯"
image: "/images/post/post-3.jpg"
date: 2024-04-20T00:02:00Z
description: "ActiveSupport::Concernã«ã¤ã„ã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰è§£èª¬ã—ã¾ã—ãŸï¼"
categories: ["Rails"]
tags: ["Ruby", "Rails"]
type: "post"
pickup: true
---

## ã¯ã˜ã‚ã«

### ã“ã®è¨˜äº‹ã¯ä½•ã‹

Railsã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã—ã¦ã„ã‚‹ã¨ã‚ˆãè¦‹ã‹ã‘ã‚‹ä»¥ä¸‹ã®1æ–‡

```ruby
extend ActiveSupport::Concern
```

å®Ÿéš›ã« Rails7.1.3.2 ã®ãƒªãƒã‚¸ãƒˆãƒªã§ grep ã™ã‚‹ã¨235ãƒ•ã‚¡ã‚¤ãƒ«ãƒ’ãƒƒãƒˆã™ã‚‹ã“ã¨ã‹ã‚‰ã‚‚ ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ Rails ã§éå¸¸ã«ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹

ä»Šå›ã¯ãã‚“ãª ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€ä½¿ã„æ–¹ã‚’ç¢ºèªã—ãŸä¸Šã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸­èº«ã‚’ç´è§£ã„ã¦ã„ã

### å¯¾è±¡ã¯èª°ã‹

Rails ã‚„ãã®ä»– gem ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«æŒ‘æˆ¦ã—ã‚ˆã†ã¨ã—ã¦ã‚‹äºº

### ã“ã®è¨˜äº‹ã®ã­ã‚‰ã„

Rails ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã‚ˆãå‡ºã¦ãã‚‹ ActiveSupport::Concern ã‚’ç†è§£ã™ã‚‹ã“ã¨ã§ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®è§£åƒåº¦ã‚’ä¸Šã’ãŸã„

<Toc headings={getHeadings()} />

## å…ˆã«çµè«–

ActiveSupport::Concern ã¨ã¯ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ includeï¼ˆã‚‚ã—ãã¯ prependï¼‰ ã—ãŸæ™‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã“ã¨

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã« ActiveSupport::Concern ã‚’ extend ã—ã¦ãŠãã“ã¨ã«ã‚ˆã£ã¦ã€ä¾å­˜é–¢ä¿‚ã‚’é©åˆ‡ã«ç®¡ç†ã—ãªãŒã‚‰ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ æ©Ÿèƒ½ã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

## å†…å®¹

### ActiveSupport::Concernã¨ã¯

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã—ãŸæ™‚ã«ã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ä¸€ç·’ã«ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ä¸€ç·’ã«è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ãŸ Rails ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã« ActiveSupport::Concern ã‚’ extend ã—ã¦ãŠãã“ã¨ã«ã‚ˆã£ã¦ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã®è¿½åŠ æ©Ÿèƒ½ã‚’ç°¡å˜ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

### ActiveSupport::Concernã®ä½¿ã„æ–¹

```ruby
module M
  #ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸­ã§ActiveSupport::Concernãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’extendã™ã‚‹
  extend ActiveSupport::Concern

  def instance_method
    puts "M#instance_method"
  end
  
  included do
    attr_accessor :name
  end

  #ClassMethodsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸­ã§ã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã«è¿½åŠ ã™ã‚‹ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã™ã‚‹
  module ClassMethods
    def class_method
      puts "M.class_method"
    end
  end
end

class C
  #ActiveSupport::Concernã‚’extendã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’includeã™ã‚‹
  include M
end

c = C.new
c.instance_method 
# => M#instance_method

c.name = "C#name"
c.name
# => C#name

C.class_method
# => M.class_method
```

ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã« ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ extend ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸­ã§ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã¯åˆ¥ã§ã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã«å¯¾ã—ã¦ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦è¿½åŠ ã—ãŸã„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å®šç¾©ã™ã‚‹

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã™ã‚‹ã¨ã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã§ ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ extend ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹

â€»å¾Œè¿°ã™ã‚‹ãŒ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ class_methods ãƒ¡ã‚½ãƒƒãƒ‰ã§å®šç¾©ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹

<Notice type="note">
æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®åç§°ã‚’ä½¿ã†

ğŸ“Â ActiveSupport::Concern ã‚’ extend ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« = ã€Œ**concern**ã€

ğŸ“Â concern ã‚’ include ã—ãŸã‚¯ãƒ©ã‚¹ = ã€Œ**ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹**ã€
</Notice>

ä»¥ä¸‹ã‚’ä¾‹ã«ã¨ã‚‹ã¨ M ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã€Œconcernã€ã€C ã‚¯ãƒ©ã‚¹ãŒã€Œãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã€ã¨ã„ã†ã“ã¨ã«ãªã‚‹

â€»ã“ã“ã‚’è¦šãˆã¦ãŠã‹ãªã„ã¨æœ¬è¨˜äº‹ã®å†…å®¹ãŒ8å‰²æ–¹ç†è§£ã§ããªããªã‚‹ã®ã§ã€æ›–æ˜§ã«ãªã£ãŸéš›ã¯éƒ½åº¦æˆ»ã£ã¦ãã¦ç¢ºèªã—ã¦æ¬²ã—ã„

```ruby
module M
  extend ActiveSupport::Concern

  def instance_method
    puts "M#instance_method"
  end
  
  included do
    attr_accessor :name
  end

  module ClassMethods
    def class_method
      puts "M.class_method"
    end
  end
end

class C
  include M
end
```

### Railsã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§å®Ÿéš›ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ç®‡æ‰€

ä¸Šã§ ActiveSupport::Concern ã®ä½¿ã„æ–¹ã‚’ç¢ºèªã—ãŸãŒã€Rails ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã¯å®Ÿéš›ã©ã®ã‚ˆã†ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ã®ã‹ï¼Ÿå…¸å‹çš„ãª User ãƒ¢ãƒ‡ãƒ«ã‚’ä¾‹ã«è¦‹ã¦ã„ã

ä»¥ä¸‹ã® User ã‚¯ãƒ©ã‚¹ã¯ username ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ApplicationRecord ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹

```ruby
# app/models/user.rb

class User < ApplicationRecord
  validates :username, presence: true
end
```

ApplicationRecord ã‚¯ãƒ©ã‚¹ã¯ ActiveRecord::Base ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹

```ruby
# app/models/application_record.rb

class ApplicationRecord < ActiveRecord::Base
end
```

ActiveRecord::Base ã‚¯ãƒ©ã‚¹ã¯ ActiveModel::API ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã—ã¦ã„ã‚‹

```ruby
# rails/activerecord/lib/active_record/base.rb

module ActiveRecord # :nodoc:
  class Base
    include ActiveModel::API
    ...
  end
end
```

ActiveModel::API ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ ActiveModel::Validations ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã—ã¦ã„ã‚‹

ã¾ãŸ ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ extend ã—ã¦ã„ã‚‹ï¼ˆã“ã“ã§ç™»å ´ï¼ï¼‰

ï¼ˆã¤ã¾ã‚Š ActiveModel::API ã¯ concern ã¨ã„ã†ã“ã¨ï¼‰

```ruby
# rails/activemodel/lib/active_model/api.rb

module ActiveModel
  module API
    extend ActiveSupport::Concern
    include ActiveModel::Validations
  end
end
```

ActiveModel::Validations ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã«ã¯ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ãã“ã§ validates ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹

```ruby
# activemodel/lib/active_model/validations/validates.rb

module ActiveModel
  module Validations
    module ClassMethods
      def validates(*attributes)
        defaults = attributes.extract_options!.dup
        validations = defaults.slice!(*_validates_default_keys)

        raise ArgumentError, "You need to supply at least one attribute" if attributes.empty?
        raise ArgumentError, "You need to supply at least one validation" if validations.empty?

        defaults[:attributes] = attributes

        validations.each do |key, options|
          key = "#{key.to_s.camelize}Validator"

          begin
            validator = const_get(key)
          rescue NameError
            raise ArgumentError, "Unknown validator: '#{key}'"
          end

          next unless options

          validates_with(validator, defaults.merge(_parse_validates_options(options)))
        end
      end
      ...
    end
  end
end
```

ã“ã‚Œã«ã‚ˆã‚Šã€ActiveModel::Validations::ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šç¾©ã•ã‚ŒãŸ validates ãƒ¡ã‚½ãƒƒãƒ‰ãŒ Userã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ãŸã‚ã€User ãƒ¢ãƒ‡ãƒ«ã§ã‚¯ãƒ©ã‚¹ãƒã‚¯ãƒ­ã¨ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚‹

ã“ã“ã‹ã‚‰ã¯ã€ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã”ã¨ã«åˆ†è§£ã—ã¦è©³ç´°ã«è¦‹ã¦ã„ãã“ã¨ã§ã€Œã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½ã‚’ã‚«ãƒ—ã‚»ãƒ«åŒ–ã—ã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã—ãŸæ™‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€æ©Ÿèƒ½ã‚’ã©ã®ã‚ˆã†ã«å®Ÿç¾ã—ã¦ã„ã‚‹ã®ã‹ã‚’ç¢ºèªã™ã‚‹

ã¾ãšã€ä»¥ä¸‹ãŒ ActiveSupport::Concern ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å…¨ä½“åƒ

```ruby
# rails/activesupport/lib/active_support/concern.rb

module ActiveSupport
  module Concern
    class MultipleIncludedBlocks < StandardError # :nodoc:
      def initialize
        super "Cannot define multiple 'included' blocks for a Concern"
      end
    end

    class MultiplePrependBlocks < StandardError # :nodoc:
      def initialize
        super "Cannot define multiple 'prepended' blocks for a Concern"
      end
    end

    def self.extended(base) # :nodoc:
      base.instance_variable_set(:@_dependencies, [])
    end

    def append_features(base) # :nodoc:
      if base.instance_variable_defined?(:@_dependencies)
        base.instance_variable_get(:@_dependencies) << self
        false
      else
        return false if base < self
        @_dependencies.each { |dep| base.include(dep) }
        super
        base.extend const_get(:ClassMethods) if const_defined?(:ClassMethods)
        base.class_eval(&@_included_block) if instance_variable_defined?(:@_included_block)
      end
    end

    def prepend_features(base) # :nodoc:
      if base.instance_variable_defined?(:@_dependencies)
        base.instance_variable_get(:@_dependencies).unshift self
        false
      else
        return false if base < self
        @_dependencies.each { |dep| base.prepend(dep) }
        super
        base.singleton_class.prepend const_get(:ClassMethods) if const_defined?(:ClassMethods)
        base.class_eval(&@_prepended_block) if instance_variable_defined?(:@_prepended_block)
      end
    end

    def included(base = nil, &block)
      if base.nil?
        if instance_variable_defined?(:@_included_block)
          if @_included_block.source_location != block.source_location
            raise MultipleIncludedBlocks
          end
        else
          @_included_block = block
        end
      else
        super
      end
    end

    def prepended(base = nil, &block)
      if base.nil?
        if instance_variable_defined?(:@_prepended_block)
          if @_prepended_block.source_location != block.source_location
            raise MultiplePrependBlocks
          end
        else
          @_prepended_block = block
        end
      else
        super
      end
    end

    def class_methods(&class_methods_module_definition)
      mod = const_defined?(:ClassMethods, false) ?
        const_get(:ClassMethods) :
        const_set(:ClassMethods, Module.new)

      mod.module_eval(&class_methods_module_definition)
    end
  end
end
```

> å‚è€ƒï¼šhttps://github.com/rails/rails/blob/main/activesupport/lib/active_support/concern.rb

### self.extended(base)

```ruby
def self.extended(base) # :nodoc:
  base.instance_variable_set(:@_dependencies, [])
end
```

ActiveSupport::Concern ã‚’ extend ã—ãŸæ™‚ã€Ruby ãŒãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å¼•æ•°ã«ã—ã¦ selfï¼ˆã“ã“ã§ã„ã†ã¨ ActiveSupport::Concern ï¼‰ã® [extended](https://docs.ruby-lang.org/ja/latest/method/Module/i/extended.html) ã¨ã„ã†ãƒ•ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã™

ã“ã“ã§ã¯ã€concernï¼ˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã„ã†ã¨ base ï¼‰ ã«å¯¾ã—ã¦ [Object#instance_variable_set](https://docs.ruby-lang.org/ja/latest/method/Object/i/instance_variable_set.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ @_dependencies ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¿ãƒ³ã‚¹å¤‰æ•°ã‚’ç©ºé…åˆ—ã§å®šç¾©ã—ã¦ã„ã‚‹

<Notice type="note">
ãƒã‚¤ãƒ³ãƒˆ

ğŸ“Â concern ã« @_dependencies = [] ã‚’å®šç¾©ã—ãŸ

ğŸ“Â å…¨ã¦ã® concern ã¯ @_dependencies ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã‚’æŒã£ã¦ã„ã‚‹
</Notice>


### class_methods(&class_methods_module_definition)

```ruby
def class_methods(&class_methods_module_definition)
  mod = const_defined?(:ClassMethods, false) ?
    const_get(:ClassMethods) :
    const_set(:ClassMethods, Module.new)

  mod.module_eval(&class_methods_module_definition)
end
```

concern ã« class_methods ãƒ¡ã‚½ãƒƒãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ã„ãŸå ´åˆã¯ã“ã®å‡¦ç†ãŒå‘¼ã°ã‚Œã‚‹

class_methods ãƒ¡ã‚½ãƒƒãƒ‰ã¯å¼•æ•°ã¨ã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã‚’ Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¦å—ã‘å–ã‚‹

[Module#const_defined?](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§ concern ã« ClassMethods ã¨ã„ã†å®šæ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€å®šæ•°ãŒã‚ã‚Œã° [Module#const_get](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_get.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§å®šæ•°ã®å€¤ã‚’å–å¾—ã—ã€å®šæ•°ãŒãªã‘ã‚Œã°  [Module#const_set](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_set.html) ****ãƒ¡ã‚½ãƒƒãƒ‰ã§ ClassMethods ã¨ã„ã†ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹

â€» [Module#const_defined?](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¬¬äºŒå¼•æ•°ã¯ inherit ã‚’ boolean ã§æŒ‡å®šã™ã‚‹ã€‚false ã‚’æŒ‡å®šã™ã‚‹ã¨ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¹ã‚„ include ã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šç¾©ã•ã‚ŒãŸå®šæ•°ã¯å¯¾è±¡ã«å«ã¾ãªã„

æ¬¡ã« [Module#module_eval](https://docs.ruby-lang.org/ja/latest/method/Module/i/class_eval.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ Procã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆclass_methods_module_definitionï¼‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã«å¤‰æ›ã—ã¦è©•ä¾¡ã™ã‚‹

ã¤ã¾ã‚Šã€ãƒ–ãƒ­ãƒƒã‚¯ãŒ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå†…ã§è©•ä¾¡ã•ã‚Œã‚‹

```ruby
# ã“ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ãŸå ´åˆ...
module M
  extend ActiveSupport::Concern

  class_methods do
    def hoge
      'M#hoge'
    end
  end
end

# ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ç›´ã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨
module M
  module ClassMethods
    def hoge
      'M#hoge'
    end
  end
end
```

<Notice type="note">
ãƒã‚¤ãƒ³ãƒˆ

ğŸ“Â concern ã« ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã€class_methods ãƒ–ãƒ­ãƒƒã‚¯ã‚’ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è©•ä¾¡ã—ãŸ

ğŸ“Â concern å†…ã§ç›´æ¥ ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æœ¬ãƒ¡ã‚½ãƒƒãƒ‰ã¯å®Ÿè¡Œã•ã‚Œãªã„

</Notice>


### included(base = nil, &block)

```ruby
def included(base = nil, &block)
  if base.nil?
    if instance_variable_defined?(:@_included_block)
      if @_included_block.source_location != block.source_location
        raise MultipleIncludedBlocks
      end
    else
      @_included_block = block
    end
  else
    super
  end
end
```

included ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã‚’ include ã—ãŸã¨ãã«ãƒ•ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å‘¼ã°ã‚Œã‚‹

ã¾ãšã¯ã€base ãŒ nil ã‹ã©ã†ã‹ã§æ¡ä»¶åˆ†å²ã€‚base ãŒ nil ã®å ´åˆã¯å¾Œè¿°ã®å‡¦ç†ã‚’ã€base ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã›ãš [Module#included](https://docs.ruby-lang.org/ja/latest/method/Module/i/included.html) ã‚’å‘¼ã³å‡ºã™

base ãŒ nil ä»¥å¤–ã«ãªã‚‹ã®ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã« concern ãŒ include ã•ã‚ŒãŸå ´åˆã€‚ã“ã®å ´åˆã¯ M1 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ base ã«ãªã‚‹ã®ã§ã€Module ã‚¯ãƒ©ã‚¹ã® included ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹

```ruby
**module M2
  include M1
end**
```

base ãŒ nil ã«ãªã‚‹ã®ã¯ã€concern ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å‘¼ã³å‡ºã—ã‚’è¡Œã£ãŸå ´åˆ

```ruby
**module M1
  extend ActiveSupport::Concern

  included doÂ Â Â Â 
    def hoge
      puts "M#hoge"
    end
  end
end**
```

ã“ã®å ´åˆã€ã¾ãš [Object#instance_variable_defined?](https://docs.ruby-lang.org/ja/latest/method/Object/i/instance_variable_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§ @_included_block ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª

å®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å¼•æ•°ã® Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ @_included_block ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã«ä»£å…¥

å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€[Proc#source_location](https://docs.ruby-lang.org/ja/latest/method/Proc/i/source_location.html) ****ãƒ¡ã‚½ãƒƒãƒ‰ã§ @_included_block ã® Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨å¼•æ•°ã® Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¯”è¼ƒã—ã€åŒä¸€ã®å®šç¾©ã§ã¯ãªã„å ´åˆã¯ included ãƒ–ãƒ­ãƒƒã‚¯ãŒè¤‡æ•°è¨­å®šã•ã‚Œã¦ã„ã‚‹ã¨åˆ¤æ–­ã—ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹

<Notice type="note">
ãƒã‚¤ãƒ³ãƒˆ

ğŸ“Â concern ã« included ãƒ–ãƒ­ãƒƒã‚¯ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ @_included_block ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ã« Proc ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä»£å…¥ã—ãŸ
</Notice>


### append_features(base)

```ruby
def append_features(base) # :nodoc:
  if base.instance_variable_defined?(:@_dependencies)
    base.instance_variable_get(:@_dependencies) << self
    false
  else
    return false if base < self
    @_dependencies.each { |dep| base.include(dep) }
    super
    base.extend const_get(:ClassMethods) if const_defined?(:ClassMethods)
    base.class_eval(&@_included_block) if instance_variable_defined?(:@_included_block)
  end
end
```

append_features ãƒ¡ã‚½ãƒƒãƒ‰ã¯ Module ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã¯ã€ŒModule#include ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿæ…‹ã€ã¨è¡¨ç¾ã•ã‚Œã¦ãŠã‚Šã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã‚‹

æœ¬ãƒ¡ã‚½ãƒƒãƒ‰ã¯ [Module#append_features](https://docs.ruby-lang.org/ja/latest/method/Module/i/append_features.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã„ã‚‹ãŸã‚ã€concern ã‚’ include ã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹

ã¾ãšã¯ [Object#instance_variable_defined?](https://docs.ruby-lang.org/ja/latest/method/Object/i/instance_variable_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§  ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã« @_dependencies ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ãŒã‚ã‚‹ã‹ã©ã†ã‹ã§æ¡ä»¶åˆ†å²ï¼ˆ= ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã‹ã©ã†ã‹ã‚’åˆ¤å®šã—ã¦ã„ã‚‹ï¼‰

ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã« @_dependencies ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼ˆ= ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã®å ´åˆï¼‰ã€[Object#instance_variable_get](https://docs.ruby-lang.org/ja/latest/method/Object/i/instance_variable_get.html) ****ãƒ¡ã‚½ãƒƒãƒ‰ã§ ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã® @_dependencies (Array) ã‚’å–å¾—ã—ã€self ã‚’è¿½åŠ ã™ã‚‹

concern ã« concern ã‚’ include ã™ã‚‹ã¨ã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’èª­ã¿è¾¼ã‚€ã¹ãã‚¯ãƒ©ã‚¹ãŒãšã‚Œã¦ã—ã¾ã†ãŸã‚ã€ã“ã®å ´åˆã¯ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã«è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ä»£ã‚ã‚Šã«ã€@_dependencies ã«è‡ªèº«ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ä¾å­˜ç®¡ç†ã‚’å®Ÿç¾ã—ã¦ã„ã‚‹

ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã« @_dependencies ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆ= ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã§ã¯ãªã„å ´åˆï¼‰ã€ä»¥ä¸‹ã®å‡¦ç†ã‚’è¡Œãªã£ã¦ã„ã‚‹

ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã« self ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯äºŒé‡ã®include ã‚’é˜²ããŸã‚ã« false ã‚’è¿”ã—ã€include ã‚’ä¸­æ­¢ã™ã‚‹ï¼ˆ[Module#append_features](https://docs.ruby-lang.org/ja/latest/method/Module/i/append_features.html) ãŒ include ã®å®Ÿæ…‹ã§ã‚ã‚‹ãŸã‚ super ã‚’å‘¼ã³å‡ºã•ãªã„ã¨ include ã¯è¡Œã‚ã‚Œãªã„ï¼‰

ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å‡¦ç†ã‚’ç¶šè¡Œã—ã€@_dependencies ã®é…åˆ—ã«å«ã¾ã‚Œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã«å†å¸°çš„ã« include ã—ã¦ã„ã

ãã®å¾Œã€super ã§ [Module#append_features](https://docs.ruby-lang.org/ja/latest/method/Module/i/append_features.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã€self ã‚’ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã«è¿½åŠ ã™ã‚‹

ã•ã‚‰ã«ã€[Module#const_defined?](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§ ClassMethods ã¨ã„ã†å®šæ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’ç¢ºèªã—ã€å®šæ•°ãŒã‚ã‚Œã° [Module#const_get](https://docs.ruby-lang.org/ja/latest/method/Module/i/const_get.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§å®šæ•°ã‚’å–å¾—ã—ã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã« extend ã™ã‚‹

ã•ã‚‰ã« [Object#instance_variable_defined?](https://docs.ruby-lang.org/ja/latest/method/Object/i/instance_variable_defined=3f.html) ãƒ¡ã‚½ãƒƒãƒ‰ã§ @_included_block ã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã€å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ [Module#class_eval](https://docs.ruby-lang.org/ja/latest/method/Module/i/class_eval.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ @_included_block ã® Procã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã«å¤‰æ›ã—ã¦è©•ä¾¡ã™ã‚‹

ä»¥ä¸Šã®ã‚ˆã†ãªå‡¦ç†ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ include ã—ãŸæ™‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã ã‘ã§ã¯ãªãã€ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹

<Notice type="note">
ãƒã‚¤ãƒ³ãƒˆ

ğŸ“Â ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã®å ´åˆã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã® @_dependencies ã« self ã‚’è¿½åŠ ã™ã‚‹

ğŸ“Â ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã§ã¯ç„¡ã„å ´åˆã€self ã¨ @_dependencies ã®é…åˆ—ã«å«ã¾ã‚Œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã™ã¹ã¦ include ã—ã€ã•ã‚‰ã« ClassMethods ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ extend ã™ã‚‹

ğŸ“Â @_included_block ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã®å†…å®¹ã‚‚ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§è©•ä¾¡ã™ã‚‹
</Notice>


### prepended(base = nil, &block)

```ruby
def prepended(base = nil, &block)
  if base.nil?
    if instance_variable_defined?(:@_prepended_block)
      if @_prepended_block.source_location != block.source_location
        raise MultiplePrependBlocks
      end
    else
      @_prepended_block = block
    end
  else
    super
  end
end
```

prepended ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ãŒ concern ã‚’ prepend ã—ãŸã¨ãã«ãƒ•ãƒƒã‚¯ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å‘¼ã°ã‚Œã‚‹

å†…å®¹ã«ã¤ã„ã¦ã¯ included ã¨åŒã˜ãªã®ã§å‰²æ„›

### prepend_features(base)

```ruby
def prepend_features(base) # :nodoc:
  if base.instance_variable_defined?(:@_dependencies)
    base.instance_variable_get(:@_dependencies).unshift self
    false
  else
    return false if base < self
    @_dependencies.each { |dep| base.prepend(dep) }
    super
    base.singleton_class.prepend const_get(:ClassMethods) if const_defined?(:ClassMethods)
    base.class_eval(&@_prepended_block) if instance_variable_defined?(:@_prepended_block)
  end
end
```

prepend_features ãƒ¡ã‚½ãƒƒãƒ‰ã¯ Module ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ã§ã¯ã€ŒModule#prepend ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿæ…‹ã€ã¨è¡¨ç¾ã•ã‚Œã¦ãŠã‚Šã€ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ã®ç¶™æ‰¿ãƒã‚§ãƒ¼ãƒ³ã®å…ˆé ­ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã‚‹

æœ¬ãƒ¡ã‚½ãƒƒãƒ‰ã¯ [Module#prepend_feature](https://docs.ruby-lang.org/ja/latest/method/Module/i/prepend_features.html)[s](https://docs.ruby-lang.org/ja/latest/method/Module/i/append_features.html) ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã„ã‚‹ãŸã‚ã€concern ã‚’ prepend ã—ãŸã¨ãã«å‘¼ã°ã‚Œã‚‹

å†…å®¹ã«ã¤ã„ã¦ã¯ append_features ã¨ã»ã¼åŒã˜ãªã®ã§å‰²æ„›

## ãŠã‚ã‚Šã«

ã€Œãƒ¡ã‚¿ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° Rubyã€ã‚’èª­ã‚“ã§ç†è§£ã—ãŸã¤ã‚‚ã‚Šã§ã‚‚ã€ã„ã–è¨€èªåŒ–ã—ã¦ã¿ã‚‹ã¨æ„å¤–ã¨ç†è§£ã§ãã¦ãªã‹ã£ãŸã“ã¨ã«æ°—ã¥ã„ãŸ

ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆå¤§äº‹ï¼
